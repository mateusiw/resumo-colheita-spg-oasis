<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Resumo de Colheita SPG Oásis - 2026</title>
    
    <!-- Configurações PWA -->
    <link rel="icon" type="image/png" href="https://i.imgur.com/wEozr34.png">
    <link rel="apple-touch-icon" href="https://i.imgur.com/wEozr34.png">
    <link rel="manifest" href='data:application/manifest+json,{"name":"SPG Oásis 2026","short_name":"SPG Oásis","start_url":".","display":"standalone","background_color":"#ffffff","theme_color":"#ffffff","icons":[{"src":"https://i.imgur.com/wEozr34.png","sizes":"192x192","type":"image/png"},{"src":"https://i.imgur.com/wEozr34.png","sizes":"512x512","type":"image/png"}]}'>
    
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SPG Oásis">
    
    <!-- Bibliotecas Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        input, select, textarea { line-height: 1.5; }
        .animate-fade-in-down { animation: fadeInDown 0.3s ease-out forwards; }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 min-h-screen pb-20 select-none">

    <!-- Navbar -->
    <div class="bg-white border-b border-slate-200 px-4 py-3 flex justify-between items-center shadow-sm sticky top-0 z-40">
        <div class="flex items-center gap-3">
            <img src="https://i.imgur.com/wEozr34.png" alt="Logo SPG" class="w-8 h-8 rounded-lg shadow-sm border border-slate-100">
            <div>
                <h1 class="text-sm font-bold text-slate-800 leading-tight">SPG Oásis</h1>
                <p class="text-[10px] text-slate-500 font-medium">Resumo de Colheita SPG Oásis</p>
            </div>
        </div>
        <div class="flex gap-2">
            <button type="button" onclick="downloadImage()" class="flex items-center gap-2 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-xs font-bold shadow-lg shadow-blue-500/20 transition-all active:scale-95 active:bg-blue-700">
                <i data-lucide="image" class="w-4 h-4"></i>
                <span>Baixar Imagem</span>
            </button>
            <button type="button" onclick="downloadPDF()" class="flex items-center gap-2 px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-xs font-bold shadow-lg shadow-emerald-600/20 transition-all active:scale-95 active:bg-emerald-800">
                <i data-lucide="file-down" class="w-4 h-4"></i>
                <span>Baixar PDF</span>
            </button>
        </div>
    </div>

    <div class="container mx-auto p-4 flex flex-col lg:flex-row gap-8 mt-4">
        
        <!-- COLUNA DA ESQUERDA: CONTROLES -->
        <div class="w-full lg:w-1/3 space-y-4">
            
            <!-- 1. PARÂMETROS DO TURNO -->
            <div class="bg-white p-6 rounded shadow-sm border border-slate-200">
                <h2 class="text-sm font-bold text-slate-700 mb-4 flex items-center gap-2 border-b border-slate-100 pb-2">
                    <i data-lucide="settings" class="w-4 h-4 text-slate-500"></i> PARÂMETROS DO TURNO
                </h2>
                
                <div class="mb-3">
                    <label class="text-[10px] font-bold text-slate-500 mb-1 block uppercase">META / ESTIMATIVA (CAIXAS)</label>
                    <input type="text" id="estimatedBoxes" oninput="formatNumberInput(this); renderReport()" placeholder="0" class="w-full p-2 border border-slate-300 rounded text-sm bg-white focus:ring-1 focus:ring-slate-400 outline-none text-slate-700">
                </div>

                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 mb-1 block uppercase">EFETIVO (PESSOAS)</label>
                        <input type="text" id="crewCount" oninput="formatNumberInput(this); renderReport()" placeholder="0" class="w-full p-2 border border-slate-300 rounded text-sm bg-white focus:ring-1 focus:ring-slate-400 outline-none text-slate-700">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 mb-1 block uppercase">REF. ESTIMATIVA</label>
                        <select id="estimateDay" oninput="renderReport()" class="w-full p-2 border border-slate-300 rounded text-sm bg-white focus:ring-1 focus:ring-slate-400 outline-none text-slate-700">
                            <option value="">(Nenhum)</option>
                            <option value="Segunda-feira">Segunda-feira</option>
                            <option value="Terça-feira">Terça-feira</option>
                            <option value="Quarta-feira">Quarta-feira</option>
                            <option value="Quinta-feira">Quinta-feira</option>
                            <option value="Sexta-feira">Sexta-feira</option>
                            <option value="Sábado">Sábado</option>
                            <option value="Domingo">Domingo</option>
                            <option value="Amanhã">Amanhã</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-3 gap-3">
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 mb-1 block uppercase">INÍCIO</label>
                        <div class="relative">
                            <input type="time" id="startTime" oninput="renderReport()" class="w-full p-2 border border-slate-300 rounded text-sm bg-white focus:ring-1 focus:ring-slate-400 outline-none text-slate-700">
                        </div>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 mb-1 block uppercase">TÉRMINO</label>
                        <div class="relative">
                             <input type="time" id="endTime" oninput="renderReport()" class="w-full p-2 border border-slate-300 rounded text-sm bg-white focus:ring-1 focus:ring-slate-400 outline-none text-slate-700">
                        </div>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 mb-1 block uppercase">INTERVALO</label>
                        <input type="number" id="intervalDuration" oninput="renderReport()" placeholder="Min" class="w-full p-2 border border-slate-300 rounded text-sm bg-white focus:ring-1 focus:ring-slate-400 outline-none text-slate-700">
                    </div>
                </div>
            </div>

            <!-- 2. DADOS DO BLOCO -->
            <div id="formContainer" class="bg-white p-6 rounded shadow-sm border border-slate-200 transition-colors duration-300">
                <!-- Header -->
                <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-2">
                    <h2 id="formTitle" class="text-sm font-bold text-slate-700 flex items-center gap-2 uppercase">
                        <i data-lucide="clipboard-list" class="w-4 h-4 text-slate-500"></i> DADOS DO BLOCO
                    </h2>
                    <button type="button" onclick="clearBlockForm()" class="text-[10px] font-bold text-slate-400 hover:text-red-500 transition-colors flex items-center gap-1 uppercase">
                        <i data-lucide="x-circle" class="w-3 h-3"></i> LIMPAR
                    </button>
                </div>
                
                <form id="harvestForm" onsubmit="addItem(event)" class="space-y-4">
                    
                    <!-- IDENTIFICAÇÃO (BLOCO) -->
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 uppercase mb-1 block">IDENTIFICAÇÃO (BLOCO)</label>
                        <select id="talhao" required class="w-full p-2 border border-slate-300 rounded text-sm bg-white focus:ring-1 focus:ring-slate-400 outline-none text-slate-700">
                            <option value="">Selecione...</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="D">D</option>
                            <option value="E">E</option>
                        </select>
                    </div>

                    <!-- CULTURA & VARIEDADE -->
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase mb-1 block">CULTURA</label>
                            <select id="variety" onchange="updateCommercialInput()" required class="w-full p-2 border border-slate-300 rounded text-sm bg-white focus:ring-1 focus:ring-slate-400 outline-none text-slate-700">
                                <option value="">Selecione...</option>
                                <option value="Brócolis">Brócolis</option>
                                <option value="Couve-Flor">Couve-Flor</option>
                            </select>
                        </div>
                        <div id="commercialVarietyWrapper">
                            <label class="text-[10px] font-bold text-slate-500 uppercase mb-1 block">VARIEDADE</label>
                            <input type="text" id="commercialVariety" placeholder="Nome da variedade" class="w-full p-2 border border-slate-300 rounded text-sm focus:ring-1 focus:ring-slate-400 outline-none text-slate-700">
                        </div>
                    </div>

                    <!-- BOX: CRONOGRAMA -->
                    <div class="border border-slate-200 rounded p-3 bg-slate-50/30">
                        <div class="text-[10px] font-bold text-slate-400 uppercase mb-3 tracking-wider border-b border-slate-100 pb-1">CRONOGRAMA</div>
                        
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div>
                                <label class="text-[10px] font-bold text-slate-500 mb-1 block uppercase">DATA PLANTIO</label>
                                <input type="date" id="date" required class="w-full p-2 border border-slate-300 rounded text-sm bg-white focus:ring-1 focus:ring-slate-400 outline-none text-slate-700 uppercase">
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-slate-500 mb-1 block uppercase">INÍCIO COLHEITA</label>
                                <input type="date" id="startDate" required class="w-full p-2 border border-slate-300 rounded text-sm bg-white focus:ring-1 focus:ring-slate-400 outline-none text-slate-700 uppercase">
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3 mb-3">
                             <div>
                                <label class="text-[10px] font-bold text-slate-500 mb-1 block uppercase">DIAS PROD.</label>
                                <input type="number" id="productionDays" placeholder="0" class="w-full p-2 border border-slate-300 rounded text-sm bg-white focus:ring-1 focus:ring-slate-400 outline-none text-slate-700">
                            </div>
                             <div>
                                <label class="text-[10px] font-bold text-slate-500 mb-1 block uppercase">PREVISÃO TÉRMINO</label>
                                <input type="date" id="forecastDate" class="w-full p-2 border border-slate-300 rounded text-sm bg-white focus:ring-1 focus:ring-slate-400 outline-none text-slate-700 uppercase">
                            </div>
                        </div>

                        <div>
                            <label class="text-[10px] font-bold text-slate-500 mb-1 block uppercase">STATUS OPERACIONAL</label>
                            <select id="status" class="w-full p-2 border border-slate-300 rounded text-sm bg-white focus:ring-1 focus:ring-slate-400 outline-none text-slate-700">
                                <option value="EM ANDAMENTO">EM ANDAMENTO</option>
                                <option value="FINALIZADO">FINALIZADO</option>
                            </select>
                        </div>
                    </div>

                    <!-- BOX: PRODUÇÃO -->
                    <div class="border border-slate-200 rounded p-3 bg-slate-50/30">
                        <div class="flex justify-between items-center mb-3 border-b border-slate-100 pb-1">
                            <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">PRODUÇÃO</div>
                            <label class="inline-flex items-center cursor-pointer">
                                <span class="mr-2 text-[10px] font-bold text-slate-400 uppercase">ETAPAS</span>
                                <input type="checkbox" id="hasStages" onchange="toggleDetailsField()" class="sr-only peer">
                                <div class="relative w-9 h-5 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-slate-700"></div>
                            </label>
                        </div>

                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div>
                                <label class="text-[10px] font-bold text-slate-500 block uppercase mb-1">QTD. PLANTADA</label>
                                <input type="text" id="plants" oninput="formatNumberInput(this)" class="w-full p-2 border border-slate-300 rounded text-sm bg-white focus:ring-1 focus:ring-slate-400 outline-none text-slate-700 text-right" placeholder="0">
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-slate-500 mb-1 block uppercase">COLHIDO (TOTAL)</label>
                                <input type="text" id="totalUnits" oninput="formatNumberInput(this)" class="w-full p-2 border border-slate-300 rounded text-sm bg-white focus:ring-1 focus:ring-slate-400 outline-none text-slate-700 text-right" placeholder="0">
                            </div>
                        </div>

                        <div id="detailsContainer" class="hidden mb-3 bg-white p-2 rounded border border-slate-200">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-[10px] font-bold text-slate-500 flex items-center gap-1 uppercase">
                                    <i data-lucide="list" class="w-3 h-3"></i> Detalhes
                                </label>
                                <button type="button" onclick="addStageRow()" class="text-[10px] bg-slate-100 text-slate-600 hover:bg-slate-200 px-2 py-1 rounded font-bold transition-colors uppercase">
                                    + Adicionar
                                </button>
                            </div>
                            <div id="stagesList" class="space-y-2"></div>
                            <textarea id="details" class="hidden" style="display:none;"></textarea>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                             <div>
                                <label class="text-[10px] font-bold text-slate-500 mb-1 block uppercase">CAIXAS (DIA)</label>
                                <input type="text" id="boxes" oninput="formatNumberInput(this)" class="w-full p-2 border border-slate-300 rounded text-sm bg-white focus:ring-1 focus:ring-slate-400 outline-none text-slate-700 text-right" placeholder="0">
                            </div>
                             <div>
                                <label class="text-[10px] font-bold text-slate-500 mb-1 block uppercase">UNIDADES (DIA)</label>
                                <input type="text" id="dailyUnits" oninput="formatNumberInput(this)" class="w-full p-2 border border-slate-300 rounded text-sm bg-white focus:ring-1 focus:ring-slate-400 outline-none text-slate-700 text-right" placeholder="0">
                            </div>
                        </div>
                    </div>

                    <button type="submit" id="submitBtn" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 rounded transition-all flex justify-center items-center gap-2 uppercase text-xs shadow-lg shadow-slate-900/20">
                        <i data-lucide="plus-square" class="w-4 h-4"></i> <span>INSERIR NO RELATÓRIO</span>
                    </button>
                </form>
            </div>

            <!-- Lista de Itens -->
            <div class="bg-white p-6 rounded shadow-sm border border-slate-200">
                <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-2">
                    <h3 class="text-sm font-bold text-slate-700 uppercase">REGISTROS INSERIDOS</h3>
                    <button onclick="clearAll()" class="text-[10px] font-bold text-red-500 hover:text-red-700 uppercase underline">LIMPAR LISTA</button>
                </div>
                <ul id="itemsList" class="space-y-2 text-sm text-slate-600">
                    <!-- JS -->
                </ul>
            </div>
        </div>

        <!-- PREVIEW -->
        <div class="w-full lg:w-2/3 flex flex-col bg-slate-200/50 p-4 rounded-3xl border border-slate-300/50 min-h-[calc(100vh-6rem)]">
            <div id="report-card" class="w-full flex-1 flex flex-col bg-white rounded-none shadow-2xl overflow-hidden border border-slate-100 relative">
                
                <!-- Cabeçalho -->
                <div class="bg-gradient-to-br from-emerald-600 to-emerald-800 p-6 text-white relative overflow-hidden flex flex-col justify-start shrink-0 gap-3 antialiased">
                    <img src="https://i.imgur.com/wEozr34.png" alt="Logo SPG" class="absolute top-4 right-4 w-20 h-20 z-0">
                    <div class="relative z-10 w-full pr-24"> 
                        <h2 id="reportTitle" class="text-base font-bold leading-snug tracking-normal"></h2>
                        <div class="mt-3 pt-3 border-t border-white/20">
                             <span id="headerDateTime" class="text-xs font-medium text-emerald-50 block opacity-90 tracking-wide"></span>
                        </div>
                    </div>
                </div>

                <!-- Resumo Superior (Novo Local) -->
                <div id="summaryHeader" class="bg-white shrink-0"></div>

                <!-- Conteúdo -->
                <div id="reportContent" class="divide-y divide-slate-50 flex-1 overflow-y-auto">
                    <div class="p-8 text-center text-slate-400 text-xs italic leading-relaxed h-full flex items-center justify-center">Adicione blocos no formulário ao lado.</div>
                </div>

                <!-- Footer Operacional -->
                <div id="operationalFooter" class="bg-white border-t border-slate-200 p-4 shrink-0"></div>

                <!-- Rodapé Marca -->
                <div class="bg-slate-100 p-3 text-center border-t border-slate-200 shrink-0">
                    <div class="flex justify-center items-center gap-2 text-[10px] text-slate-400 font-medium uppercase tracking-widest leading-relaxed">
                        SPG Oásis • Dados Oficiais
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- JAVASCRIPT -->
    <script>
        console.log("Aplicação 'Resumo de Colheita SPG Oásis' reiniciada.");

        let harvestData = JSON.parse(localStorage.getItem('spg_harvestData')) || [];
        let editingIndex = -1;

        lucide.createIcons();
        updateDynamicTitle(); 
        loadInputs();
        
        // --- ORDENAÇÃO AO INICIAR ---
        sortHarvestData();
        renderList(); 
        renderReport(); 

        // --- FUNÇÕES DE DATA E HORA ---
        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function updateDynamicTitle() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            const weekNumber = getWeekNumber(now);
            const daysOfWeek = ["Domingo", "Segunda-feira", "Terça-feira", "Quarta-feira", "Quinta-feira", "Sexta-feira", "Sábado"];
            const dayOfWeek = daysOfWeek[now.getDay()];

            let greeting = hours < 12 ? "Bom dia, Pessoal!" : (hours < 18 ? "Boa tarde, Pessoal!" : "Boa noite, Pessoal!");
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const timeString = `${String(hours).padStart(2, '0')}:${minutes}${ampm}`; 

            document.getElementById('reportTitle').innerHTML = `${greeting}<br>Resumo da Colheita de ${dayOfWeek}`;
            document.getElementById('headerDateTime').innerText = `Data: ${day}/${month}/${year} - ${timeString} - Semana ${weekNumber}`;
        }

        // --- FORMATAÇÃO E CÁLCULOS ---
        function formatNumberInput(input) {
            let value = input.value.replace(/\D/g, '');
            input.value = value ? value.replace(/\B(?=(\d{3})+(?!\d))/g, ".") : "";
        }

        function calculateTimeDifference(start, end, interval) {
            if (!start || !end || start === "--:--" || end === "--:--") return "--:--";
            const [startH, startM] = start.split(':').map(Number);
            const [endH, endM] = end.split(':').map(Number);
            let diff = (endH * 60 + endM) - (startH * 60 + startM) - (parseInt(interval) || 0);
            if (diff < 0) return "Erro";
            return `${String(Math.floor(diff / 60)).padStart(2, '0')}:${String(diff % 60).padStart(2, '0')}`;
        }

        function parsePTBRNumber(val) {
            if (!val) return 0;
            return parseFloat(val.toString().replace(/\./g, '').replace(',', '.')) || 0;
        }

        function formatDateBR(isoStr) {
            if(!isoStr) return "";
            const [year, month, day] = isoStr.split('-');
            return `${day}/${month}/${year}`;
        }

        // --- STORAGE E ORDENAÇÃO ---
        function saveData() { localStorage.setItem('spg_harvestData', JSON.stringify(harvestData)); }
        function saveInputs() {
            const inputs = {
                estimatedBoxes: document.getElementById('estimatedBoxes').value,
                crewCount: document.getElementById('crewCount').value,
                estimateDay: document.getElementById('estimateDay').value,
                startTime: document.getElementById('startTime').value,
                endTime: document.getElementById('endTime').value,
                intervalDuration: document.getElementById('intervalDuration').value
            };
            localStorage.setItem('spg_inputs', JSON.stringify(inputs));
        }
        function loadInputs() {
            const saved = localStorage.getItem('spg_inputs');
            if (saved) {
                try {
                    const inputs = JSON.parse(saved);
                    ['estimatedBoxes', 'crewCount', 'estimateDay', 'startTime', 'endTime', 'intervalDuration'].forEach(id => {
                        if(inputs[id]) document.getElementById(id).value = inputs[id];
                    });
                } catch (e) { console.error("Erro ao carregar inputs", e); }
            }
        }

        // --- NOVA FUNÇÃO DE ORDENAÇÃO ---
        function sortHarvestData() {
            harvestData.sort((a, b) => {
                if (!a.date || !b.date) return 0;
                const [dayA, monthA, yearA] = a.date.split('/').map(Number);
                const [dayB, monthB, yearB] = b.date.split('/').map(Number);
                return new Date(yearA, monthA - 1, dayA) - new Date(yearB, monthB - 1, dayB);
            });
        }

        // --- LÓGICA DE ETAPAS ---
        function toggleDetailsField() {
            const checkbox = document.getElementById('hasStages');
            const container = document.getElementById('detailsContainer');
            if (checkbox.checked) {
                container.classList.remove('hidden');
                if (document.getElementById('stagesList').children.length === 0) addStageRow();
            } else {
                container.classList.add('hidden');
            }
        }

        function addStageRow(label = '', value = '') {
            const container = document.getElementById('stagesList');
            const rowId = 'stage-' + Date.now();
            
            if (!label) {
                const startDateVal = document.getElementById('startDate').value;
                let weekNum = 1;
                if (startDateVal) weekNum = getWeekNumber(new Date(startDateVal));
                
                const existingLabels = Array.from(container.querySelectorAll('.stage-label')).map(i => i.value.trim());
                while (existingLabels.includes(`Semana ${weekNum}`)) weekNum++;
                label = `Semana ${weekNum}`;
            }

            const div = document.createElement('div');
            div.className = "flex gap-2 items-center";
            div.id = rowId;
            div.innerHTML = `
                <div class="flex-1"><input type="text" value="${label}" class="stage-label w-full p-2 border border-slate-300 rounded text-xs focus:ring-1 focus:ring-slate-400 outline-none text-slate-700 uppercase" placeholder="Semana X"></div>
                <div class="w-1/3"><input type="text" value="${value}" oninput="formatNumberInput(this)" class="stage-value w-full p-2 border border-slate-300 rounded text-xs focus:ring-1 focus:ring-slate-400 outline-none text-slate-700 text-right" placeholder="Qtd"></div>
                <button type="button" onclick="document.getElementById('${rowId}').remove()" class="text-red-400 hover:text-red-600 p-1"><i data-lucide="x" class="w-4 h-4"></i></button>
            `;
            container.appendChild(div);
            lucide.createIcons();
        }

        function updateDetailsFromRows() {
            const rows = document.querySelectorAll('#stagesList div[id^="stage-"]');
            let text = "";
            rows.forEach(row => {
                const label = row.querySelector('.stage-label').value;
                const val = row.querySelector('.stage-value').value;
                if (label || val) text += `${label}: ${val}\n`;
            });
            document.getElementById('details').value = text.trim();
        }

        // --- FORMULÁRIO ---
        function updateCommercialInput() {
            const variety = document.getElementById('variety').value;
            const wrapper = document.getElementById('commercialVarietyWrapper');
            let html = `<label class="text-[10px] font-bold text-slate-500 uppercase mb-1 block">VARIEDADE</label>`;
            
            if (variety === 'Brócolis') {
                html += `<select id="commercialVariety" class="w-full p-2 border border-slate-300 rounded text-sm bg-white focus:ring-1 focus:ring-slate-400 outline-none text-slate-700"><option value="">Selecione...</option><option value="BRO 68 Syngenta">BRO 68 Syngenta</option><option value="Master TSV">Master TSV</option><option value="Sakata Jiraya F1">Sakata Jiraya F1</option><option value="PHAR LAP">PHAR LAP</option></select>`;
            } else if (variety === 'Couve-Flor') {
                html += `<select id="commercialVariety" class="w-full p-2 border border-slate-300 rounded text-sm bg-white focus:ring-1 focus:ring-slate-400 outline-none text-slate-700"><option value="">Selecione...</option><option value="Vereda">Vereda</option><option value="Copacabana">Copacabana</option><option value="Tirsuli">Tirsuli</option><option value="SF-1758 F1">SF-1758 F1</option><option value="Champagne Snow">Champagne Snow</option><option value="Serena">Serena</option><option value="Supremo">Supremo</option></select>`;
            } else {
                html += `<input type="text" id="commercialVariety" placeholder="Nome da variedade" class="w-full p-2 border border-slate-300 rounded text-sm focus:ring-1 focus:ring-slate-400 outline-none text-slate-700">`;
            }
            wrapper.innerHTML = html;
        }

        function clearBlockForm() {
            ['talhao','startDate','date','plants','totalUnits','boxes','dailyUnits','details', 'productionDays', 'status', 'forecastDate'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.value = (id === 'status' ? 'EM ANDAMENTO' : '');
            });
            document.getElementById('stagesList').innerHTML = '';
            document.getElementById('hasStages').checked = false;
            toggleDetailsField();
            document.getElementById('variety').selectedIndex = 0;
            updateCommercialInput();
            editingIndex = -1;
            
            const btn = document.getElementById('submitBtn');
            btn.innerHTML = '<i data-lucide="plus-square" class="w-4 h-4"></i> <span>INSERIR NO RELATÓRIO</span>';
            btn.classList.replace('bg-blue-600', 'bg-slate-800');
            btn.classList.replace('hover:bg-blue-700', 'hover:bg-slate-900');
            document.getElementById('formTitle').innerHTML = '<i data-lucide="clipboard-list" class="w-4 h-4 text-slate-500"></i> DADOS DO BLOCO';
            document.getElementById('formContainer').classList.remove('border-blue-300', 'ring-2', 'ring-blue-100');
            lucide.createIcons();
        }

        function addItem(e) {
            e.preventDefault();
            updateDetailsFromRows();
            const plantsRaw = document.getElementById('plants').value;
            const totalUnitsRaw = document.getElementById('totalUnits').value;
            
            const item = {
                talhao: document.getElementById('talhao').value,
                variety: document.getElementById('variety').value,
                commercialVariety: document.getElementById('commercialVariety').value,
                percentage: parsePTBRNumber(plantsRaw) > 0 ? Math.round((parsePTBRNumber(totalUnitsRaw) / parsePTBRNumber(plantsRaw)) * 100) : 0,
                startDate: formatDateBR(document.getElementById('startDate').value),
                date: formatDateBR(document.getElementById('date').value),
                forecastDate: formatDateBR(document.getElementById('forecastDate').value),
                plants: plantsRaw,
                dailyUnits: document.getElementById('dailyUnits').value,
                boxes: document.getElementById('boxes').value,
                totalUnits: totalUnitsRaw,
                days: document.getElementById('productionDays').value,
                status: document.getElementById('status').value === 'FINALIZADO' ? 'Finalizado' : 'Em Andamento', 
                details: document.getElementById('details').value
            };

            if (editingIndex >= 0) harvestData[editingIndex] = item;
            else harvestData.push(item);
            
            sortHarvestData();
            saveData();
            clearBlockForm();
            renderReport();
            renderList();
        }

        function editItem(index) {
            const item = harvestData[index];
            editingIndex = index;
            document.getElementById('talhao').value = item.talhao;
            document.getElementById('variety').value = item.variety;
            updateCommercialInput();
            document.getElementById('commercialVariety').value = item.commercialVariety;
            
            if(item.date) document.getElementById('date').value = item.date.split('/').reverse().join('-');
            if(item.startDate) document.getElementById('startDate').value = item.startDate.split('/').reverse().join('-');
            if(item.forecastDate) document.getElementById('forecastDate').value = item.forecastDate.split('/').reverse().join('-');
            
            ['plants','totalUnits','boxes','dailyUnits'].forEach(k => {
                const el = document.getElementById(k);
                if (el) el.value = item[k] || '';
            });

            document.getElementById('status').value = item.status === 'Finalizado' ? 'FINALIZADO' : 'EM ANDAMENTO';
            
            document.getElementById('productionDays').value = item.days || '';

            document.getElementById('details').value = item.details || '';
            const stagesList = document.getElementById('stagesList');
            stagesList.innerHTML = '';
            if (item.details && item.details.trim()) {
                document.getElementById('hasStages').checked = true;
                item.details.split('\n').forEach(line => {
                    const [l, v] = line.split(':');
                    addStageRow(l?.trim(), v?.trim());
                });
            } else {
                document.getElementById('hasStages').checked = false;
            }
            toggleDetailsField();

            const btn = document.getElementById('submitBtn');
            btn.innerHTML = '<i data-lucide="save" class="w-4 h-4"></i> <span>SALVAR ALTERAÇÕES</span>';
            btn.classList.replace('bg-slate-800', 'bg-blue-600');
            btn.classList.replace('hover:bg-slate-900', 'hover:bg-blue-700');
            document.getElementById('formTitle').innerHTML = '<i data-lucide="pencil" class="w-4 h-4 text-blue-600"></i> EDITANDO BLOCO';
            document.getElementById('formContainer').classList.add('border-blue-300', 'ring-2', 'ring-blue-100');
            document.getElementById('formContainer').scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            renderList();
            lucide.createIcons();
        }

        function removeItem(index) {
            if (editingIndex === index) clearBlockForm();
            else if (editingIndex > index) editingIndex--;
            harvestData.splice(index, 1);
            saveData();
            renderReport();
            renderList();
        }

        function clearAll() {
            if(confirm('Tem certeza?')) {
                harvestData = [];
                saveData();
                clearBlockForm();
                renderReport();
                renderList();
            }
        }

        function renderList() {
            const list = document.getElementById('itemsList');
            list.innerHTML = harvestData.length ? '' : '<li class="text-center text-slate-400 italic py-2">Nenhum bloco adicionado.</li>';
            harvestData.forEach((item, index) => {
                const active = index === editingIndex ? 'border-blue-400 bg-blue-50 ring-1' : 'border-slate-100 bg-slate-50';
                list.innerHTML += `
                    <li class="flex justify-between items-center p-2 rounded border ${active} transition-all">
                        <span><b>#${item.talhao}</b> - ${item.variety} <span class="text-slate-500 text-xs">(${item.date.substring(0,5)})</span> ${index === editingIndex ? '<span class="text-[10px] text-blue-600 font-bold ml-2">(Editando)</span>' : ''}</span>
                        <div class="flex items-center">
                            <button onclick="editItem(${index})" class="text-blue-500 hover:bg-blue-100 p-1.5 rounded-md mr-1"><i data-lucide="pencil" width="14"></i></button>
                            <button onclick="removeItem(${index})" class="text-red-500 hover:bg-red-100 p-1.5 rounded-md"><i data-lucide="trash-2" width="14"></i></button>
                        </div>
                    </li>`;
            });
            lucide.createIcons();
        }

        function renderReport() {
            saveInputs();
            const container = document.getElementById('reportContent');
            const summaryHeader = document.getElementById('summaryHeader');
            const footer = document.getElementById('operationalFooter');
            let sumBoxes = 0, sumDailyUnits = 0;

            if (!harvestData.length) {
                container.innerHTML = `<div class="p-8 text-center text-slate-400 text-xs italic">Adicione dados no formulário ao lado.</div>`;
            } else {
                container.innerHTML = '';
                harvestData.forEach(item => {
                    let progressColor = item.percentage >= 90 ? 'bg-emerald-500' : (item.percentage >= 70 ? 'bg-blue-500' : 'bg-yellow-500');
                    let textColor = item.percentage >= 90 ? 'text-emerald-600' : 'text-slate-600';
                    sumBoxes += parsePTBRNumber(item.boxes);
                    sumDailyUnits += parsePTBRNumber(item.dailyUnits);

                    // --- STATUS TEXT ONLY ---
                    const isFinalized = item.status === 'Finalizado';
                    const statusBadge = `
                        <div class="text-[10px] font-bold ${isFinalized ? 'text-red-600' : 'text-blue-600'} uppercase tracking-wider">
                            ${item.status || 'Em Andamento'}
                        </div>
                    `;

                    let plantedBlockHtml = '';
                    if (item.details && item.details.trim()) {
                        const lines = item.details.split('\n');
                        const detailsListHtml = lines.map(line => {
                            const [l, v] = line.split(':');
                            return `
                            <div class="relative pl-3">
                                <div class="absolute left-0 top-1/2 -translate-y-1/2 w-3 h-[2px] bg-slate-300"></div>
                                <div class="w-full py-1 px-2 text-[10px] text-slate-600 flex justify-start gap-3 items-center">
                                    <span class="font-medium text-slate-500 whitespace-nowrap">${l}</span>
                                    ${v ? `<span class="font-bold text-slate-800">${v}</span>` : ''}
                                </div>
                            </div>`;
                        }).join('');

                        plantedBlockHtml = `
                        <div class="grid grid-cols-1 gap-2">
                            <div class="flex flex-row items-stretch bg-slate-50 rounded-xl overflow-hidden border border-slate-100 min-h-[80px]">
                                <div class="relative flex flex-col items-center justify-center p-2 w-1/3 bg-slate-50 shrink-0 z-10 border-r border-slate-100">
                                     <div class="mb-1 text-slate-400"><i data-lucide="leaf" width="14"></i></div>
                                     <span class="text-xs font-bold text-slate-700">${item.plants}</span>
                                     <span class="text-[8px] uppercase tracking-wider font-semibold text-slate-400 mt-1 text-center leading-tight">QTD. PLANTADA</span>
                                     <div class="absolute right-0 top-1/2 -translate-y-1/2 w-2 h-2 bg-slate-300 rounded-full translate-x-[50%] z-20"></div>
                                </div>
                                <div class="flex-1 py-2 pr-2 pl-10 flex flex-col justify-center relative bg-white/50">
                                     <div class="absolute left-0 top-1/2 -translate-y-1/2 w-10 h-[2px] bg-slate-300"></div>
                                     <div class="absolute left-10 top-3 bottom-3 w-[2px] bg-slate-300"></div>
                                     <div class="flex flex-col gap-1">${detailsListHtml}</div>
                                </div>
                            </div>
                        </div>`;
                    } else {
                        plantedBlockHtml = `
                        <div class="grid grid-cols-1 gap-2">
                            <div class="flex flex-col items-center justify-center p-3 rounded-xl bg-slate-50">
                                <div class="mb-1 text-slate-400"><i data-lucide="leaf" width="14"></i></div>
                                <span class="text-xs font-bold text-slate-700">${item.plants}</span>
                                <span class="text-[9px] uppercase tracking-wider font-semibold text-slate-400 mt-1 text-center leading-tight">QTD. PLANTADA</span>
                            </div>
                        </div>`;
                    }

                    container.innerHTML += `
                    <div class="p-5 hover:bg-slate-50 transition-colors group">
                        <div class="flex justify-between items-center mb-3">
                            <div class="flex items-center gap-3">
                                <span class="text-base font-bold text-slate-800">Bloco ${item.talhao}</span>
                                ${statusBadge}
                            </div>
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wide text-right">${item.commercialVariety ? `${item.variety} - ${item.commercialVariety}` : item.variety}</span>
                        </div>

                        <div class="bg-slate-50 p-3 rounded-xl border border-slate-100 mb-4">
                            <div class="flex justify-between items-end mb-1">
                                <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wide">Colhido</div>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs font-medium text-slate-500">Total Acumulado: <span class="font-bold text-slate-700">${item.totalUnits} un.</span></span>
                                    <span class="text-slate-300 text-xs">|</span>
                                    <span class="text-xs font-bold text-slate-400">Falta: <span class="text-red-400">${Math.max(0, 100 - item.percentage)}%</span></span>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="flex-1 h-2.5 bg-slate-200 rounded-full overflow-hidden"><div class="h-full rounded-full ${progressColor}" style="width: ${item.percentage}%"></div></div>
                                <span class="text-sm font-extrabold ${textColor}">${item.percentage}%</span>
                            </div>
                            
                            <div class="flex justify-between items-center mt-2 gap-2">
                                <div class="text-[11px] font-bold text-blue-600">Dias de Produção: ${item.days} dias</div>
                                ${item.forecastDate ? `<div class="text-[10px] font-bold text-orange-600">Data Final (Est.): ${item.forecastDate}</div>` : ''}
                            </div>
                        </div>

                        <div class="flex flex-col gap-3"> 
                            ${plantedBlockHtml}
                            <div class="grid grid-cols-2 gap-2">
                                ${createStatItem('calendar', item.date, 'DATA PLANTIO')}
                                ${createStatItem('calendar-days', item.startDate, 'DATA DE INÍCIO COLHEITA')}
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                ${createStatItem('package', item.dailyUnits, 'UNIDADES (HOJE)', true)}
                                ${createStatItem('box', item.boxes, 'CAIXAS (HOJE)')}
                            </div>
                        </div>
                    </div>`;
                });
            }

            const crewValue = document.getElementById('crewCount').value;
            const crew = crewValue ? (parseInt(crewValue) === 1 ? `${crewValue} Colaborador` : `${crewValue} Colaboradores`) : '-';
            const estDay = document.getElementById('estimateDay').value || '';
            
            // Renderiza o cabeçalho de resumo (Totais e Estimativa)
            summaryHeader.innerHTML = `
                <div class="p-4 pb-0 border-b border-slate-100">
                    <div class="bg-emerald-50 rounded-lg p-4 mb-3 flex justify-around items-center border border-emerald-100">
                        <div class="text-center">
                            <div class="text-[10px] text-emerald-600 font-bold uppercase mb-1">TOTAL DE UNIDADES (HOJE)</div>
                            <div class="text-xl font-extrabold text-emerald-800">${sumDailyUnits.toLocaleString('pt-BR')}</div>
                        </div>
                        <div class="w-px h-10 bg-emerald-200"></div>
                        <div class="text-center">
                            <div class="text-[10px] text-emerald-600 font-bold uppercase mb-1">TOTAL DE CAIXAS (HOJE)</div>
                            <div class="text-xl font-extrabold text-emerald-800">${sumBoxes.toLocaleString('pt-BR')}</div>
                        </div>
                    </div>
                    <div class="flex justify-center items-center pb-3">
                        <span class="text-base font-bold text-[#00838f]">${estDay ? `Estimativas de Caixas para ${estDay}:` : 'Estimativas de Caixas:'} <span class="text-[#00838f] text-2xl font-extrabold">${document.getElementById('estimatedBoxes').value || '-'}</span></span>
                    </div>
                </div>`;

            // Renderiza o footer operacional (Equipe e Horários)
            footer.innerHTML = `
                <div class="flex justify-center items-center mb-4 pb-4 border-b border-slate-200 border-dashed">
                     <span class="text-xs font-bold text-slate-600">Equipe de Colheita: <span class="text-slate-800 text-sm font-extrabold">${crew}</span></span>
                </div>
                <div class="text-center mb-2">
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Horas de Colheita</span>
                </div>
                <div class="grid grid-cols-4 gap-2 text-[10px] text-slate-500 font-medium mb-1">
                    <div class="flex flex-col items-center"><span class="text-green-600 font-bold mb-0.5 uppercase">Início</span><span class="text-slate-700 font-bold text-xs">${document.getElementById('startTime').value || '--:--'}</span></div>
                    <div class="flex flex-col items-center border-l border-slate-200"><span class="text-red-600 font-bold mb-0.5 uppercase">Final</span><span class="text-slate-700 font-bold text-xs">${document.getElementById('endTime').value || '--:--'}</span></div>
                    <div class="flex flex-col items-center border-l border-slate-200"><span class="text-amber-600 font-bold mb-0.5 uppercase">INTERVALO</span><span class="text-slate-700 font-bold text-xs">${document.getElementById('intervalDuration').value || '0'} min</span></div>
                    <div class="flex flex-col items-center border-l border-slate-200"><span class="text-emerald-700 font-bold mb-0.5 uppercase">Total</span><span class="text-slate-900 font-extrabold text-xs">${calculateTimeDifference(document.getElementById('startTime').value, document.getElementById('endTime').value, document.getElementById('intervalDuration').value)} h</span></div>
                </div>`;
            lucide.createIcons();
        }

        function createStatItem(iconName, value, label, highlight = false) {
            const bgClass = highlight ? 'bg-emerald-50' : 'bg-slate-50';
            const iconClass = highlight ? 'text-emerald-600' : 'text-slate-400';
            const valueClass = highlight ? 'text-emerald-800' : 'text-slate-700';
            const labelClass = highlight ? 'text-emerald-600' : 'text-slate-400';

            return `
            <div class="flex flex-col items-center justify-center p-3 rounded-xl ${bgClass}">
                <div class="mb-1 ${iconClass} icon-fix"><i data-lucide="${iconName}" width="14"></i></div>
                <span class="text-xs font-bold ${valueClass}">${value}</span>
                <span class="text-[9px] uppercase tracking-wider font-semibold ${labelClass} mt-1 text-center leading-tight">${label}</span>
            </div>`;
        }

        async function downloadImage() {
            const element = document.getElementById('report-card');
            const btnSpan = document.querySelector('button[onclick="downloadImage()"] span');
            const originalText = btnSpan.innerText;
            btnSpan.innerText = "Gerando Imagem...";

            try {
                const options = {
                    scale: 5,
                    useCORS: true, 
                    allowTaint: true,
                    scrollY: -window.scrollY,
                    backgroundColor: '#ffffff', 
                    onclone: (doc) => {
                        const el = doc.getElementById('report-card');
                        const content = doc.getElementById('reportContent');
                        if (el) { 
                            el.style.width = '450px'; 
                            el.style.maxWidth = '450px';
                            el.style.margin = '0'; 
                            el.style.boxShadow = 'none';
                            el.style.borderRadius = '0';
                            el.style.border = 'none';
                        }
                        if (content) { 
                            content.style.height = 'auto'; 
                            content.style.overflow = 'visible'; 
                            content.style.maxHeight = 'none';
                        }
                    }
                };

                const canvas = await html2canvas(element, options);
                const imgData = canvas.toDataURL('image/png');
                const now = new Date();
                const daysOfWeek = ["Domingo", "Segunda-feira", "Terça-feira", "Quarta-feira", "Quinta-feira", "Sexta-feira", "Sábado"];
                const dayOfWeek = daysOfWeek[now.getDay()];
                const day = String(now.getDate()).padStart(2, '0');
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const year = now.getFullYear();
                const weekNumber = getWeekNumber(now); 
                const filename = `Resumo Colheita - ${dayOfWeek} ${day}-${month}-${year} Semana ${weekNumber} - SPG Oásis.png`;
                const link = document.createElement('a');
                link.href = imgData;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (err) {
                console.error("Erro ao gerar imagem:", err);
            } finally {
                btnSpan.innerText = originalText;
            }
        }

        async function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const element = document.getElementById('report-card');
            const btnSpan = document.querySelector('button[onclick="downloadPDF()"] span');
            const originalText = btnSpan.innerText;
            btnSpan.innerText = "Gerando PDF...";
            
            try {
                const options = {
                    scale: 3,
                    useCORS: true,
                    allowTaint: true,
                    scrollY: -window.scrollY,
                    backgroundColor: '#ffffff',
                    onclone: (doc) => {
                        const el = doc.getElementById('report-card');
                        const content = doc.getElementById('reportContent');
                        if (el) { 
                            el.style.width = '450px';
                            el.style.maxWidth = '450px';
                            el.style.margin = '0'; 
                            el.style.boxShadow = 'none';
                            el.style.borderRadius = '0';
                            el.style.border = 'none';
                        }
                        if (content) { 
                            content.style.height = 'auto'; 
                            content.style.overflow = 'visible'; 
                            content.style.maxHeight = 'none';
                        }
                    }
                };
                const canvas = await html2canvas(element, options);
                const imgWidth = 450;
                const pageHeight = (canvas.height * imgWidth) / canvas.width;
                const pdf = new jsPDF({
                    orientation: 'p',
                    unit: 'px',
                    format: [imgWidth, pageHeight],
                    hotfixes: ['px_scaling']
                });
                const imgData = canvas.toDataURL('image/png');
                pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, pageHeight);
                const now = new Date();
                const daysOfWeek = ["Domingo", "Segunda-feira", "Terça-feira", "Quarta-feira", "Quinta-feira", "Sexta-feira", "Sábado"];
                const dayOfWeek = daysOfWeek[now.getDay()];
                const day = String(now.getDate()).padStart(2, '0');
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const year = now.getFullYear();
                const weekNumber = getWeekNumber(now); 
                const filename = `Resumo Colheita - ${dayOfWeek} ${day}-${month}-${year} Semana ${weekNumber} - SPG Oásis.pdf`;
                pdf.save(filename);
            } catch (err) { 
                console.error("Erro ao gerar PDF:", err);
            } finally { 
                btnSpan.innerText = originalText; 
            }
        }
    </script>
</body>
</html>
