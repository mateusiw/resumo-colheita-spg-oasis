<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Resumo de Colheita SPG Oásis - 2026</title>
    
    <!-- Configurações PWA com Ícone Personalizado -->
    <!-- Ícone para navegadores -->
    <link rel="icon" type="image/png" href="https://i.imgur.com/wEozr34.png">
    <!-- Ícone para iOS (iPhone/iPad) -->
    <link rel="apple-touch-icon" href="https://i.imgur.com/wEozr34.png">
    <!-- Manifesto Web App com ícones definidos -->
    <link rel="manifest" href='data:application/manifest+json,{"name":"SPG Oásis 2026","short_name":"SPG Oásis","start_url":".","display":"standalone","background_color":"#ffffff","theme_color":"#ffffff","icons":[{"src":"https://i.imgur.com/wEozr34.png","sizes":"192x192","type":"image/png"},{"src":"https://i.imgur.com/wEozr34.png","sizes":"512x512","type":"image/png"}]}'>
    
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SPG Oásis">
    
    <!-- Bibliotecas Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- 1. Importar Biblioteca jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* Garante espaçamento melhor em inputs no mobile */
        input, select { line-height: 1.5; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 min-h-screen pb-20 select-none">

    <!-- Navbar -->
    <div class="bg-white border-b border-slate-200 px-4 py-3 flex justify-between items-center shadow-sm sticky top-0 z-40">
        <div class="flex items-center gap-3">
            <!-- Ícone PWA Adicionado na Navbar -->
            <img src="https://i.imgur.com/wEozr34.png" alt="Logo SPG" class="w-8 h-8 rounded-lg shadow-sm border border-slate-100">
            <div>
                <h1 class="text-sm font-bold text-slate-800 leading-tight">SPG Oásis</h1>
                <p class="text-[10px] text-slate-500 font-medium">Resumo de Colheita SPG Oásis</p>
            </div>
        </div>
        <div class="flex gap-2">
            <!-- 2. Botão HTML de Baixar PDF -->
            <button type="button" onclick="downloadPDF()" class="flex items-center gap-2 px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-xs font-bold shadow-lg shadow-emerald-600/20 transition-all active:scale-95 active:bg-emerald-800">
                <i data-lucide="file-down" class="w-4 h-4"></i>
                <span>Baixar PDF</span>
            </button>
        </div>
    </div>

    <div class="container mx-auto p-4 flex flex-col lg:flex-row gap-8 mt-4">
        
        <!-- COLUNA DA ESQUERDA: CONTROLES -->
        <div class="w-full lg:w-1/3 space-y-4">
            
            <!-- 1. DADOS GERAIS DO DIA (Operacional) -->
            <div class="bg-blue-50 p-6 rounded-2xl shadow-sm border border-blue-100">
                <h2 class="text-sm font-bold text-blue-800 mb-3 flex items-center gap-2">
                    <i data-lucide="clock" class="text-blue-600"></i> Dados Gerais do Dia
                </h2>
                <div class="text-[10px] text-blue-600/70 mb-3 leading-relaxed">* Estes dados aparecem uma vez no final do relatório.</div>
                
                <!-- AJUSTE: Estimativas de Caixas movido para o topo -->
                <div class="mb-2">
                    <label class="text-[10px] font-bold text-slate-500 mb-1 block">Estimativas de Caixas (Qtd)</label>
                    <input type="text" id="estimatedBoxes" oninput="formatNumberInput(this); renderReport()" placeholder="Ex: 200" class="w-full p-2 border border-blue-200 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                </div>

                <!-- AJUSTE: Qtd Pessoas e Dia da Estimativa lado a lado em baixo -->
                <div class="grid grid-cols-2 gap-3 mb-2">
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 mb-1 block">Qtd Pessoas</label>
                        <input type="text" id="crewCount" oninput="formatNumberInput(this); renderReport()" placeholder="Ex: 5" class="w-full p-2 border border-blue-200 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 mb-1 block">Dia da Estimativa</label>
                        <select id="estimateDay" oninput="renderReport()" class="w-full p-2 border border-blue-200 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="">(Vazio)</option>
                            <option value="Segunda">Segunda-feira</option>
                            <option value="Terça">Terça-feira</option>
                            <option value="Quarta">Quarta-feira</option>
                            <option value="Quinta">Quinta-feira</option>
                            <option value="Sexta">Sexta-feira</option>
                            <option value="Sábado">Sábado</option>
                            <option value="Domingo">Domingo</option>
                            <option value="Amanhã">Amanhã</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-3 gap-2">
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 mb-1 block">Início</label>
                        <input type="time" id="startTime" oninput="renderReport()" class="w-full p-2 border border-blue-200 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 mb-1 block">Final</label>
                        <input type="time" id="endTime" oninput="renderReport()" class="w-full p-2 border border-blue-200 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 mb-1 block">Intervalo (Min)</label>
                        <input type="number" id="intervalDuration" oninput="renderReport()" placeholder="60" class="w-full p-2 border border-blue-200 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                </div>
            </div>

            <!-- 2. ADICIONAR BLOCOS -->
            <div id="formContainer" class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 transition-colors duration-300">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="formTitle" class="text-lg font-bold text-slate-800 flex items-center gap-2">
                        <i data-lucide="file-plus" class="text-emerald-600"></i> Adicionar Bloco
                    </h2>
                    <button type="button" onclick="clearBlockForm()" class="text-xs font-semibold text-slate-400 hover:text-red-500 transition-colors flex items-center gap-1">
                        <i data-lucide="eraser" class="w-3 h-3"></i> Limpar/Cancelar
                    </button>
                </div>
                
                <form id="harvestForm" onsubmit="addItem(event)" class="space-y-4">
                    
                    <!-- CAMPO BLOCO (AGORA UM SELECT) -->
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase mb-1 block">Nº Bloco</label>
                        <select id="talhao" required class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none text-sm bg-white">
                            <option value="">Selecione...</option>
                            <option value="1 - A">1 - A</option>
                            <option value="2 - A">2 - A</option>
                            <option value="3 - A">3 - A</option>
                            <option value="4 - A">4 - A</option>
                            <option value="5 - A">5 - A</option>
                            <option value="6 - A">6 - A</option>
                            <option value="7 - A">7 - A</option>
                            <option value="8 - A">8 - A</option>
                            <option value="9 - A">9 - A</option>
                            <option value="10 - A">10 - A</option>
                            <option value="11 - A">11 - A</option>
                            <option value="1 - B">1 - B</option>
                            <option value="2 - B">2 - B</option>
                            <option value="3 - B">3 - B</option>
                            <option value="4 - B">4 - B</option>
                            <option value="5 - B">5 - B</option>
                        </select>
                    </div>

                    <!-- LINHA DE VARIEDADE E COMERCIAL -->
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-xs font-bold text-slate-500 uppercase mb-1 block">Cultura</label>
                            <!-- AJUSTE: Adicionado onchange para atualizar variedades -->
                            <select id="variety" onchange="updateCommercialInput()" required class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none text-sm bg-white">
                                <option value="">Selecione...</option>
                                <option value="Brócolis">Brócolis</option>
                                <option value="Couve-Flor">Couve-Flor</option>
                            </select>
                        </div>
                        <div id="commercialVarietyWrapper">
                            <label class="text-xs font-bold text-slate-500 uppercase mb-1 block">Var. Comercial</label>
                            <!-- O conteúdo deste input será alterado via JS dependendo da cultura -->
                            <input type="text" id="commercialVariety" placeholder="Ex: Avenger" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none text-sm">
                        </div>
                    </div>

                    <!-- INFORMAÇÕES ADICIONAIS -->
                    <div class="border-t border-slate-100 my-2 pt-2">
                        <label class="text-xs font-bold text-slate-400 block mb-3">Informações Adicionais</label>
                        
                        <!-- Linha 1: Datas - ORDEM INVERTIDA NO FORMULÁRIO -->
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div>
                                <label class="text-[10px] font-bold text-slate-500 mb-1 block">DAT</label>
                                <input type="date" id="date" required class="w-full p-2 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-emerald-500 outline-none">
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-slate-500 mb-1 block">Início de Colheita</label>
                                <input type="date" id="startDate" required class="w-full p-2 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-emerald-500 outline-none">
                            </div>
                        </div>

                        <!-- Linha 2: Quantidades Iniciais -->
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div>
                                <label class="text-[10px] font-bold text-slate-500 mb-1 block">Transplantio (Qtd)</label>
                                <input type="text" id="plants" oninput="formatNumberInput(this)" placeholder="Ex: 10.000" class="w-full p-2 border border-slate-300 rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-slate-500 mb-1 block">Total de Unidades</label>
                                <input type="text" id="totalUnits" oninput="formatNumberInput(this)" placeholder="Ex: 5.000" class="w-full p-2 border border-slate-300 rounded-lg text-sm">
                            </div>
                        </div>

                        <!-- Linha 3: Caixas e Dia -->
                        <div class="grid grid-cols-2 gap-2 mb-2">
                             <div>
                                <label class="text-[10px] font-bold text-slate-500 mb-1 block">Caixas</label>
                                <input type="text" id="boxes" oninput="formatNumberInput(this)" placeholder="Ex: 50" class="w-full p-2 border border-slate-300 rounded-lg text-sm">
                            </div>
                             <div>
                                <label class="text-[10px] font-bold text-slate-500 mb-1 block">Unidades (hoje)</label>
                                <input type="text" id="dailyUnits" oninput="formatNumberInput(this)" placeholder="Ex: 5.000" class="w-full p-2 border border-slate-300 rounded-lg text-sm">
                            </div>
                        </div>

                        <div class="text-[10px] text-slate-400 mt-3 italic flex flex-col gap-1 leading-relaxed">
                            <span>* Percentual: Automático</span>
                            <span>* Dias Produção: Automático</span>
                        </div>
                    </div>

                    <button type="submit" id="submitBtn" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 rounded-xl transition-all flex justify-center items-center gap-2 mt-4 active:scale-95">
                        <i data-lucide="plus-circle" class="w-4 h-4"></i> <span>Adicionar ao Relatório</span>
                    </button>
                </form>
            </div>

            <!-- Lista de Itens -->
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-sm font-bold text-slate-700">Itens Gerados</h3>
                    <button onclick="clearAll()" class="text-xs text-red-500 hover:text-red-700 font-bold underline">Limpar Tudo</button>
                </div>
                <ul id="itemsList" class="space-y-2 text-sm text-slate-600">
                    <!-- JS -->
                </ul>
            </div>
        </div>

        <!-- PREVIEW -->
        <!-- AJUSTE: Container cinza agora é flex-col para controlar a altura -->
        <div class="w-full lg:w-2/3 flex flex-col bg-slate-200/50 p-4 rounded-3xl border border-slate-300/50 min-h-[calc(100vh-6rem)]">
            
            <!-- AJUSTE: 
                 - max-w-md REMOVIDO para w-full
                 - flex-1 adicionado para ocupar altura
                 - flex-col adicionado para rodapé fixo
            -->
            <div id="report-card" class="w-full flex-1 flex flex-col bg-white rounded-3xl shadow-2xl overflow-hidden border border-slate-100 relative">
                
                <!-- Cabeçalho (AJUSTADO PARA MOBILE) -->
                <div class="bg-gradient-to-br from-emerald-600 to-emerald-800 p-6 text-white relative overflow-hidden flex flex-col justify-start shrink-0 gap-3">
                    
                    <!-- LOGO ADICIONADA: ABSOLUTE TOP RIGHT -->
                    <!-- AJUSTE: Tamanho DIMINUÍDO (w-20 h-20) e bordas removidas -->
                    <img src="https://i.imgur.com/wEozr34.png" alt="Logo SPG" class="absolute top-4 right-4 w-20 h-20 z-0">

                    <!-- AJUSTE: Padding DIMINUÍDO (pr-24) para acompanhar a logo menor -->
                    <div class="relative z-10 w-full pr-24"> 
                        <!-- TÍTULO DINÂMICO DE 2 LINHAS -->
                        <!-- AJUSTE: Tamanho do texto reduzido de text-lg para text-base, adicionado tracking-normal -->
                        <h2 id="reportTitle" class="text-base font-bold leading-snug tracking-normal">
                            <!-- Injetado via JS -->
                        </h2>
                        
                        <!-- LINHA DE DATA DESTAQUE (Line 3) -->
                        <div class="mt-3 pt-3 border-t border-white/20">
                             <!-- AJUSTE: Tamanho do texto reduzido de text-sm para text-xs -->
                             <span id="headerDateTime" class="text-xs font-medium text-emerald-50 block opacity-90 tracking-wide">
                                <!-- Injetado via JS -->
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Conteúdo (FLEX-1 para empurrar rodapé) -->
                <div id="reportContent" class="divide-y divide-slate-50 flex-1 overflow-y-auto">
                    <div class="p-8 text-center text-slate-400 text-xs italic leading-relaxed h-full flex items-center justify-center">Adicione blocos no formulário ao lado.</div>
                </div>

                <!-- Operacional Footer: MUDANÇA DE bg-slate-50 PARA bg-white, shrink-0 para não amassar -->
                <div id="operationalFooter" class="bg-white border-t border-slate-200 p-4 shrink-0">
                     <!-- Conteúdo injetado via JS -->
                </div>

                <!-- Rodapé da Marca, shrink-0 -->
                <div class="bg-slate-100 p-3 text-center border-t border-slate-200 shrink-0">
                    <div class="flex justify-center items-center gap-2 text-[10px] text-slate-400 font-medium uppercase tracking-widest leading-relaxed">
                        <!-- Logo (agora apenas texto para manter limpo, já que está no header) -->
                        SPG Oásis • Dados Oficiais
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        console.log("Aplicação 'Resumo de Colheita SPG Oásis' carregada com sucesso.");

        let harvestData = [];
        let editingIndex = -1; // Variável para controlar se estamos editando um item

        lucide.createIcons();
        updateDynamicTitle(); // Atualiza título e data no novo formato
        renderList(); 
        renderReport(); 

        // --- FUNÇÕES DE DATA E HORA ---

        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return weekNo;
        }

        function updateDynamicTitle() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            const weekNumber = getWeekNumber(now);
            
            const daysOfWeek = ["Domingo", "Segunda-feira", "Terça-feira", "Quarta-feira", "Quinta-feira", "Sexta-feira", "Sábado"];
            const dayOfWeek = daysOfWeek[now.getDay()];

            // Lógica de Saudação
            let greeting = "Bom dia, Pessoal!";
            if (hours >= 12 && hours < 18) greeting = "Boa tarde, Pessoal!";
            else if (hours >= 18) greeting = "Boa noite, Pessoal!";

            // Lógica AM/PM para formato solicitado (ex: 20:00PM)
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const timeString = `${String(hours).padStart(2, '0')}:${minutes}${ampm}`; 

            // Construção do HTML
            
            // Linhas 1 e 2: Saudação e "Resumo da Colheita de [Dia]"
            const titleElement = document.getElementById('reportTitle');
            // GARANTE ESPAÇOS:
            titleElement.innerHTML = `${greeting}<br>Resumo da Colheita de ${dayOfWeek}`;

            // Linha 3: Data Completa
            // Formato: Data: 24/12/2025 - 20:00PM - Semana 52
            const dateElement = document.getElementById('headerDateTime');
            dateElement.innerText = `Data: ${day}/${month}/${year} - ${timeString} - Semana ${weekNumber}`;
        }

        // --- FUNÇÕES DE FORMATAÇÃO E CÁLCULO ---

        // --- NOVA FUNÇÃO DE MÁSCARA ---
        function formatNumberInput(input) {
            // Remove tudo que não for dígito
            let value = input.value.replace(/\D/g, '');
            
            // Se tiver valor, formata com pontos de milhar
            if (value) {
                // Regex para adicionar ponto a cada 3 dígitos (formato PT-BR padrão para milhares)
                input.value = value.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            } else {
                input.value = "";
            }
        }

        function calculateTimeDifference(start, end, interval) {
            if (!start || !end || start === "--:--" || end === "--:--") return "--:--";

            const [startH, startM] = start.split(':').map(Number);
            const [endH, endM] = end.split(':').map(Number);
            
            let startMin = startH * 60 + startM;
            let endMin = endH * 60 + endM;
            let intervalMin = parseInt(interval) || 0;

            let diff = endMin - startMin - intervalMin;
            
            if (diff < 0) return "Erro";

            const hours = Math.floor(diff / 60);
            const minutes = diff % 60;

            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
        }

        function calculateDaysFromStart(isoDateStr) {
            if (!isoDateStr) return 0;
            const [year, month, day] = isoDateStr.split('-').map(Number);
            const start = new Date(year, month - 1, day);
            const now = new Date();
            start.setHours(0,0,0,0);
            now.setHours(0,0,0,0);
            const diffTime = now - start; 
            if(diffTime < 0) return 0;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            return diffDays; 
        }

        function parsePTBRNumber(val) {
            if (!val) return 0;
            const cleanStr = val.toString().replace(/\./g, '').replace(',', '.');
            return parseFloat(cleanStr) || 0;
        }

        function formatDateBR(isoStr) {
            if(!isoStr) return "";
            const [year, month, day] = isoStr.split('-');
            return `${day}/${month}/${year}`;
        }

        // --- FUNÇÕES DE OPERAÇÃO DA LISTA E FORMULÁRIO ---

        // AJUSTE: Função para atualizar campo Var. Comercial Dinamicamente
        function updateCommercialInput() {
            const variety = document.getElementById('variety').value;
            const wrapper = document.getElementById('commercialVarietyWrapper');
            
            if (variety === 'Brócolis') {
                // Se for Brócolis, muda para Select com opções específicas
                wrapper.innerHTML = `
                    <label class="text-xs font-bold text-slate-500 uppercase mb-1 block">Var. Comercial</label>
                    <select id="commercialVariety" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none text-sm bg-white">
                        <option value="">Selecione...</option>
                        <option value="BRO 68 Syngenta">BRO 68 Syngenta</option>
                        <option value="Master TSV">Master TSV</option>
                        <option value="Sakata Jiraya F1">Sakata Jiraya F1</option>
                        <option value="PHAR LAP">PHAR LAP</option>
                    </select>
                `;
            } else if (variety === 'Couve-Flor') {
                // Se for Couve-Flor, muda para Select com opções específicas
                wrapper.innerHTML = `
                    <label class="text-xs font-bold text-slate-500 uppercase mb-1 block">Var. Comercial</label>
                    <select id="commercialVariety" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none text-sm bg-white">
                        <option value="">Selecione...</option>
                        <option value="Vereda">Vereda</option>
                        <option value="Copacabana">Copacabana</option>
                        <option value="Tirsuli">Tirsuli</option>
                        <option value="SF-1758 F1">SF-1758 F1</option>
                        <option value="Champagne Snow">Champagne Snow</option>
                        <option value="Serena">Serena</option>
                        <option value="Supremo">Supremo</option>
                    </select>
                `;
            } else {
                // Se for outro, volta para Input Texto
                wrapper.innerHTML = `
                    <label class="text-xs font-bold text-slate-500 uppercase mb-1 block">Var. Comercial</label>
                    <input type="text" id="commercialVariety" placeholder="Ex: Avenger" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none text-sm">
                `;
            }
        }

        // LIMPAR / CANCELAR EDIÇÃO
        function clearBlockForm() {
            document.getElementById('talhao').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('date').value = '';
            document.getElementById('plants').value = '';
            document.getElementById('totalUnits').value = '';
            document.getElementById('boxes').value = '';
            document.getElementById('dailyUnits').value = '';
            
            // Reseta Cultura e Atualiza Var. Comercial
            const varietySelect = document.getElementById('variety');
            varietySelect.selectedIndex = 0;
            updateCommercialInput(); // Reseta para input texto

            // RESETA ESTADO DE EDIÇÃO
            editingIndex = -1;
            const submitBtn = document.getElementById('submitBtn');
            const formTitle = document.getElementById('formTitle');
            const formContainer = document.getElementById('formContainer');

            // Volta para estilo de "Adicionar"
            submitBtn.innerHTML = '<i data-lucide="plus-circle" class="w-4 h-4"></i> <span>Adicionar ao Relatório</span>';
            submitBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            submitBtn.classList.add('bg-slate-800', 'hover:bg-slate-900');
            
            formTitle.innerHTML = '<i data-lucide="file-plus" class="text-emerald-600"></i> Adicionar Bloco';
            formContainer.classList.remove('border-blue-300', 'ring-2', 'ring-blue-100');
            
            lucide.createIcons();
        }

        // --- NOVA LÓGICA DE EDITAR: POPULA FORM SEM APAGAR ---
        function editItem(index) {
            const item = harvestData[index];
            editingIndex = index; // MARCA O ÍNDICE QUE ESTÁ SENDO EDITADO

            // Preenche o formulário
            document.getElementById('talhao').value = item.talhao;
            document.getElementById('variety').value = item.variety;
            updateCommercialInput(); // Atualiza o HTML do Var. Comercial
            document.getElementById('commercialVariety').value = item.commercialVariety;

            // Datas (converte DD/MM/AAAA -> YYYY-MM-DD)
            if (item.date) document.getElementById('date').value = item.date.split('/').reverse().join('-');
            if (item.startDate) document.getElementById('startDate').value = item.startDate.split('/').reverse().join('-');

            // Números
            document.getElementById('plants').value = item.plants;
            document.getElementById('totalUnits').value = item.totalUnits;
            document.getElementById('boxes').value = item.boxes;
            document.getElementById('dailyUnits').value = item.dailyUnits;

            // MUDA A APARÊNCIA PARA "MODO EDIÇÃO"
            const submitBtn = document.getElementById('submitBtn');
            const formTitle = document.getElementById('formTitle');
            const formContainer = document.getElementById('formContainer');

            submitBtn.innerHTML = '<i data-lucide="save" class="w-4 h-4"></i> <span>Salvar Alterações</span>';
            submitBtn.classList.remove('bg-slate-800', 'hover:bg-slate-900');
            submitBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');

            formTitle.innerHTML = '<i data-lucide="pencil" class="text-blue-600"></i> Editando Bloco';
            formContainer.classList.add('border-blue-300', 'ring-2', 'ring-blue-100');

            // Rola até o formulário para facilitar no mobile
            formContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Re-renderiza a lista para mostrar o indicador "(Editando)"
            renderList();
            
            lucide.createIcons();
            
            // NÃO CHAMAMOS removeItem(index) AQUI!
        }

        function addItem(e) {
            e.preventDefault();

            const plantsRaw = document.getElementById('plants').value;
            const totalUnitsRaw = document.getElementById('totalUnits').value;
            const startDateVal = document.getElementById('startDate').value;
            const dateVal = document.getElementById('date').value; 

            const plantsVal = parsePTBRNumber(plantsRaw);
            const totalUnitsVal = parsePTBRNumber(totalUnitsRaw);
            let calculatedPercentage = 0;
            if (plantsVal > 0) {
                calculatedPercentage = Math.round((totalUnitsVal / plantsVal) * 100);
            }

            const calculatedDays = calculateDaysFromStart(startDateVal);
            const formattedStartDate = formatDateBR(startDateVal);
            const formattedDate = formatDateBR(dateVal);

            const newItem = {
                talhao: document.getElementById('talhao').value,
                variety: document.getElementById('variety').value,
                commercialVariety: document.getElementById('commercialVariety').value,
                percentage: calculatedPercentage, 
                startDate: formattedStartDate,    
                date: formattedDate, 
                plants: plantsRaw, 
                dailyUnits: document.getElementById('dailyUnits').value,
                boxes: document.getElementById('boxes').value,
                totalUnits: totalUnitsRaw, 
                days: calculatedDays, 
            };

            if (editingIndex >= 0) {
                // SE ESTIVER EM MODO EDIÇÃO, ATUALIZA O ITEM EXISTENTE
                harvestData[editingIndex] = newItem;
                // Reseta o modo de edição após salvar
                clearBlockForm(); 
            } else {
                // SE NÃO, ADICIONA NOVO
                harvestData.push(newItem);
                clearBlockForm(); // Limpa o formulário para o próximo
            }

            renderReport();
            renderList();
        }

        function removeItem(index) {
            // Se estiver editando este item específico, cancela a edição primeiro
            if (editingIndex === index) {
                clearBlockForm();
            }
            // Se remover um item que vem antes do que está sendo editado, ajusta o índice
            else if (editingIndex > index) {
                editingIndex--;
            }

            harvestData.splice(index, 1);
            renderReport();
            renderList();
        }

        function clearAll() {
            if(confirm('Tem certeza?')) {
                harvestData = [];
                clearBlockForm(); // Garante que saia do modo de edição
                renderReport();
                renderList();
            }
        }

        // --- FUNÇÕES DE RENDERIZAÇÃO ---

        function renderList() {
            const list = document.getElementById('itemsList');
            list.innerHTML = '';

            if (harvestData.length === 0) {
                const emptyLi = document.createElement('li');
                emptyLi.className = "text-center text-slate-400 italic py-2";
                emptyLi.innerText = "Nenhum bloco adicionado.";
                list.appendChild(emptyLi);
                return;
            }

            harvestData.forEach((item, index) => {
                const li = document.createElement('li');
                // Adiciona destaque visual se for o item sendo editado
                const activeClass = (index === editingIndex) ? 'border-blue-400 bg-blue-50 ring-1 ring-blue-200' : 'border-slate-100 bg-slate-50';
                
                // Extrai "DD/MM" da data (item.date formato DD/MM/AAAA)
                const shortDate = item.date ? item.date.substring(0, 5) : '';

                li.className = `flex justify-between items-center p-2 rounded border ${activeClass} transition-all`;
                li.innerHTML = `
                    <span><b>#${item.talhao}</b> - ${item.variety} <span class="text-slate-500 font-medium">(${shortDate})</span> ${index === editingIndex ? '<span class="text-[10px] text-blue-600 font-bold ml-2">(Editando)</span>' : ''}</span>
                    <div class="flex items-center">
                        <button onclick="editItem(${index})" class="text-blue-500 hover:bg-blue-100 p-1.5 rounded-md mr-1 transition-colors" title="Editar">
                            <i data-lucide="pencil" width="14"></i>
                        </button>
                        <button onclick="removeItem(${index})" class="text-red-500 hover:bg-red-100 p-1.5 rounded-md transition-colors" title="Excluir">
                            <i data-lucide="trash-2" width="14"></i>
                        </button>
                    </div>
                `;
                list.appendChild(li);
            });
            lucide.createIcons();
        }

        function renderReport() {
            const container = document.getElementById('reportContent');
            const footerContainer = document.getElementById('operationalFooter');

            container.innerHTML = '';
            let sumBoxes = 0;
            let sumDailyUnits = 0;

            if (harvestData.length === 0) {
                // AJUSTE: Centralizar mensagem de vazio
                container.innerHTML = `<div class="p-8 text-center text-slate-400 text-xs italic leading-relaxed h-full flex items-center justify-center">Adicione dados no formulário ao lado para visualizar.</div>`;
            } else {
                harvestData.forEach(item => {
                    let progressColor = 'bg-yellow-500';
                    let textColor = 'text-slate-600';
                    if (item.percentage >= 90) { progressColor = 'bg-emerald-500'; textColor = 'text-emerald-600'; }
                    else if (item.percentage >= 70) { progressColor = 'bg-blue-500'; }

                    const displayVariety = item.commercialVariety ? `${item.variety} - ${item.commercialVariety}` : item.variety;
                    const remainingPercentage = Math.max(0, 100 - item.percentage);
                    
                    sumBoxes += parsePTBRNumber(item.boxes);
                    sumDailyUnits += parsePTBRNumber(item.dailyUnits);

                    // AJUSTE: REORGANIZAÇÃO COMPLETA DO LAYOUT DO CARD
                    const html = `
                    <div class="p-5 hover:bg-slate-50 transition-colors group">
                        
                        <!-- 1. TOPO: TÍTULO + TAG (LADO A LADO) -->
                        <div class="flex items-center gap-3 mb-3">
                            <span class="text-base font-bold text-slate-800 leading-normal">
                                Bloco ${item.talhao}
                            </span>
                            <!-- AJUSTE: Ícone de tag removido -->
                            <div class="flex items-center gap-1">
                                <span class="text-[10px] font-bold text-slate-600 uppercase leading-normal tracking-wide">${displayVariety}</span>
                            </div>
                        </div>

                        <!-- 2. BARRA DE PROGRESSO + INFO (ABAIXO DO TÍTULO) -->
                        <div class="bg-slate-50 p-3 rounded-xl border border-slate-100 mb-4">
                            <div class="flex justify-between items-end mb-1">
                                <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wide">Colhido</div>
                                <div class="flex items-center gap-2">
                                    <!-- AJUSTE: Aumentado de text-[10px] para text-xs -->
                                    <span class="text-xs font-medium text-slate-500">
                                        Total: <span class="font-bold text-slate-700">${item.totalUnits} un.</span>
                                    </span>
                                    <span class="text-slate-300 text-xs">|</span>
                                    <!-- AJUSTE: Aumentado de text-[10px] para text-xs -->
                                    <span class="text-xs font-bold text-slate-400">
                                        Falta: <span class="text-red-400">${remainingPercentage}%</span>
                                    </span>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-3">
                                <div class="flex-1 h-2.5 bg-slate-200 rounded-full overflow-hidden">
                                    <div class="h-full rounded-full ${progressColor}" style="width: ${item.percentage}%"></div>
                                </div>
                                <!-- AJUSTE: Aumentado de text-xs para text-sm e font-extrabold -->
                                <span class="text-sm font-extrabold ${textColor}">${item.percentage}%</span>
                            </div>
                        </div>

                        <!-- Grid de Estatísticas (SEM BORDAS) -->
                        <div class="flex flex-col gap-3"> <!-- Aumentado de gap-2 para gap-3 -->
                            <!-- Linha 1: Métricas Quantitativas (Apenas Transplantio) -->
                            <div class="grid grid-cols-1 gap-2">
                                ${createStatItem('leaf', item.plants, 'Transplantio')}
                            </div>
                            
                            <!-- Linha 2: Datas (REVERTIDA ORDEM NO CARD) -->
                            <div class="grid grid-cols-2 gap-2">
                                 <div class="flex flex-col items-center justify-center p-3 rounded-xl bg-slate-50">
                                    <div class="mb-1 text-slate-400"><i data-lucide="calendar" width="14"></i></div>
                                    <span class="text-xs font-bold text-slate-700">${item.date}</span>
                                    <span class="text-[9px] uppercase tracking-wider font-semibold text-slate-400 mt-1">DAT</span>
                                </div>
                                <div class="flex flex-col items-center justify-center p-3 rounded-xl bg-slate-50">
                                    <div class="mb-1 text-slate-400"><i data-lucide="calendar-days" width="14"></i></div>
                                    <span class="text-xs font-bold text-slate-700">${item.startDate}</span>
                                    <span class="text-[9px] uppercase tracking-wider font-semibold text-slate-400 mt-1">Início</span>
                                </div>
                            </div>

                            <!-- Linha 3: Caixas e Unidades Hoje -->
                            <div class="grid grid-cols-2 gap-2">
                                ${createStatItem('box', item.boxes, 'Caixas', true)}
                                <!-- AJUSTE AQUI: Mudou de 'Unidades (hoje)' para 'Unidades' -->
                                ${createStatItem('package', item.dailyUnits, 'Unidades')}
                            </div>
                        </div>

                        <!-- AJUSTE: mt-4 para não grudar no grid de cima -->
                        <div class="mt-4 flex items-center justify-between text-[10px] text-slate-400 font-medium bg-slate-50/50 px-2 py-2 rounded-lg">
                            <span class="flex items-center gap-1">
                                <!-- Ícone removido aqui -->
                                Dias de Produção: ${item.days} dias
                            </span>
                        </div>
                    </div>
                    `;
                    container.innerHTML += html;
                });
            }

            // RODAPÉ OPERACIONAL (SEM BORDAS)
            const crewInput = document.getElementById('crewCount').value;
            const crew = crewInput ? (parseInt(crewInput) === 1 ? `${crewInput} Colaborador` : `${crewInput} Colaboradores`) : '-';
            const est = document.getElementById('estimatedBoxes').value || '-';
            const estDay = document.getElementById('estimateDay').value || ''; // Novo campo de dia
            const start = document.getElementById('startTime').value || '--:--';
            const end = document.getElementById('endTime').value || '--:--';
            const interval = document.getElementById('intervalDuration').value || '0';
            
            const totalHours = calculateTimeDifference(start, end, interval);
            const sumBoxesStr = sumBoxes.toLocaleString('pt-BR');
            const sumDailyUnitsStr = sumDailyUnits.toLocaleString('pt-BR');

            // Formatando o label da estimativa
            const estimateLabel = estDay ? `Est. Caixas (${estDay}):` : 'Estimativas de Caixas:';

            footerContainer.innerHTML = `
                <!-- NOVO PAINEL DE TOTAIS -->
                <div class="bg-emerald-50 rounded-lg p-4 mb-4 flex justify-around items-center">
                    <div class="text-center">
                        <div class="text-[10px] text-emerald-600 font-bold uppercase mb-1">Total Caixas</div>
                        <div class="text-xl font-extrabold text-emerald-800">${sumBoxesStr}</div>
                    </div>
                    <div class="w-px h-10 bg-emerald-200"></div>
                    <div class="text-center">
                        <div class="text-[10px] text-emerald-600 font-bold uppercase mb-1">Total Unidades</div>
                        <div class="text-xl font-extrabold text-emerald-800">${sumDailyUnitsStr}</div>
                    </div>
                </div>

                <div class="flex justify-between items-center mb-4 pb-4 border-b border-slate-200 border-dashed">
                     <div class="flex items-center gap-2">
                        <!-- Icone de Equipe REMOVIDO -->
                        <!-- AJUSTE: Aumentado de text-[10px] para text-xs e valor para text-sm -->
                        <span class="text-xs font-bold text-slate-600">Equipe: <span class="text-slate-800 text-sm font-extrabold">${crew}</span></span>
                    </div>
                     <div class="flex items-center gap-2">
                        <!-- Icone de Estimativas REMOVIDO -->
                        <!-- AJUSTE: Aumentado de text-[10px] para text-xs e valor para text-sm -->
                        <span class="text-xs font-bold text-emerald-700">${estimateLabel} <span class="text-emerald-900 text-sm font-extrabold">${est} Cx</span></span>
                    </div>
                </div>
                
                <!-- AJUSTE: Removido bg-white e sombras, agora é apenas texto centralizado -->
                <div class="grid grid-cols-4 gap-2 text-[10px] text-slate-500 font-medium mb-1 mt-2">
                    <div class="flex flex-col items-center">
                        <span class="text-green-600 font-bold mb-0.5 uppercase tracking-wide">Início</span>
                        <span class="text-slate-700 font-bold text-xs">${start}</span>
                    </div>
                    <div class="flex flex-col items-center border-l border-slate-200">
                        <span class="text-red-600 font-bold mb-0.5 uppercase tracking-wide">Final</span>
                        <span class="text-slate-700 font-bold text-xs">${end}</span>
                    </div>
                    <div class="flex flex-col items-center border-l border-slate-200">
                        <span class="text-amber-600 font-bold mb-0.5 uppercase tracking-wide">Interv.</span>
                        <span class="text-slate-700 font-bold text-xs">${interval} min</span>
                    </div>
                    <div class="flex flex-col items-center border-l border-slate-200">
                        <span class="text-emerald-700 font-bold mb-0.5 uppercase tracking-wide">Total</span>
                        <span class="text-slate-900 font-extrabold text-xs">${totalHours} h</span>
                    </div>
                </div>
            `;

            lucide.createIcons();
        }

        // Helper (SEM BORDAS)
        function createStatItem(iconName, value, label, highlight = false) {
            const textColor = highlight ? 'text-emerald-800' : 'text-slate-700';
            const labelColor = highlight ? 'text-emerald-600/70' : 'text-slate-400';
            const iconColor = highlight ? 'text-emerald-600' : 'text-slate-400';
            const bgColor = highlight ? 'bg-emerald-50/50' : 'bg-slate-50';

            return `
            <div class="flex flex-col items-center justify-center p-3 rounded-xl ${bgColor}">
                <div class="mb-1 ${iconColor} icon-fix"><i data-lucide="${iconName}" width="14"></i></div>
                <span class="text-xs font-bold ${textColor}">${value}</span>
                <span class="text-[9px] uppercase tracking-wider font-semibold ${labelColor} mt-1 text-center leading-tight">${label}</span>
            </div>
            `;
        }

        // 3. Função JavaScript para Baixar PDF (Infinito) - REVERTIDA PARA A LÓGICA ANTERIOR (INFINITA)
        async function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const element = document.getElementById('report-card');
            const originalText = document.querySelector('button[onclick="downloadPDF()"] span').innerText;
            document.querySelector('button[onclick="downloadPDF()"] span').innerText = "Gerando PDF...";

            try {
                // Captura o elemento como Canvas
                const canvas = await html2canvas(element, {
                    scale: 2, // Melhora a qualidade
                    useCORS: true, // Permite carregar imagens externas se configurado no servidor
                    allowTaint: true,
                    scrollY: -window.scrollY,
                    windowWidth: 480, // Simula largura mobile
                    onclone: (clonedDoc) => {
                        const clonedElement = clonedDoc.getElementById('report-card');
                        const clonedContent = clonedDoc.getElementById('reportContent');

                        // Ajustes de estilo para garantir que tudo apareça no PDF
                        const style = clonedDoc.createElement('style');
                        // Removido text-rendering: optimizeLegibility para evitar problemas de espaçamento de texto
                        style.innerHTML = `
                            * { 
                                -webkit-font-smoothing: antialiased !important; 
                                -moz-osx-font-smoothing: grayscale !important; 
                            }
                        `;
                        clonedDoc.head.appendChild(style);

                        if (clonedElement) {
                            clonedElement.style.width = '450px';
                            clonedElement.style.maxWidth = 'none';
                            clonedElement.style.height = 'auto'; 
                            clonedElement.style.margin = '0';
                            clonedElement.style.borderRadius = '0'; 
                            clonedElement.style.border = 'none'; 
                            clonedElement.style.boxShadow = 'none';
                            clonedElement.style.overflow = 'visible';
                        }

                        if (clonedContent) {
                            clonedContent.style.height = 'auto';
                            clonedContent.style.overflow = 'visible';
                            clonedContent.style.flex = 'none';
                        }
                    }
                });

                const imgData = canvas.toDataURL('image/png');
                const imgWidth = canvas.width;
                const imgHeight = canvas.height;

                // Cria o PDF com o tamanho exato da imagem gerada (Página Infinita)
                const pdf = new jsPDF({
                    orientation: 'p',
                    unit: 'px',
                    format: [imgWidth, imgHeight]
                });

                pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                pdf.save(`Relatorio-SPG-Oasis-${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.pdf`);

            } catch (err) {
                alert("Erro ao gerar PDF: " + err);
                console.error(err);
            } finally {
                document.querySelector('button[onclick="downloadPDF()"] span').innerText = originalText;
            }
        }
    </script>
</body>
</html>
